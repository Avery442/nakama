package evr

import (
	"encoding/json"
	"net"
	"testing"

	"github.com/gofrs/uuid/v5"
	"github.com/google/go-cmp/cmp"
)

func TestGameServerSesssionParsers(t *testing.T) {
	testCases := []struct {
		name string
		data []byte
		want Message
	}{
		{
			name: "Game Server Registration",
			data: []byte{
				0x6e, 0xb6, 0xc0, 0xe4, 0xaa, 0xb1, 0xef, 0x11, 0xa3, 0xa0, 0x66, 0xd3, 0xff, 0x8a, 0x65, 0x3b,
				0x5b, 0x1f, 0xd2, 0xd4, 0xff, 0x3b, 0xe7, 0x94, 0xc0, 0xa8, 0x38, 0x01, 0x88, 0x1a, 0x00, 0x00,
				0x9e, 0x5b, 0x61, 0x5f, 0x99, 0x8a, 0xd3, 0x2f, 0x0d, 0x91, 0x77, 0x8f, 0xd7, 0x01, 0x2f, 0xc6,
				0x8d, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			},
			want: &EchoToolsGameServerRegistrationRequestV1{
				LoginSessionID: uuid.UUID{
					0xe4, 0xc0, 0xb6, 0x6e, 0xb1, 0xaa, 0x11, 0xef,
					0xa3, 0xa0, 0x66, 0xd3, 0xff, 0x8a, 0x65, 0x3b,
				},
				ServerID:      10729610607206735707,
				InternalIP:    net.IPv4(192, 168, 56, 1),
				Port:          6792,
				RegionHash:    Symbol(0x8a995f615b9e0000),
				VersionLock:   132732457728159699,
				TimeStepUsecs: 546162223,
			},
		},
		{
			name: "Game Server Session Status",
			data: []byte{
				0x39, 0x6b, 0x43, 0x37, 0x65, 0x4b, 0x4c, 0x6e, 0x6a, 0x4c, 0x74, 0x35, 0x58, 0x62, 0x71, 0x6c,
				0x77, 0x56, 0x42, 0x6b, 0x73, 0x68, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
				0x64, 0x69, 0x76, 0x70, 0x71, 0x33, 0x66, 0x6f, 0x62, 0x55, 0x36, 0x35, 0x32, 0x49, 0x61, 0x6e,
				0x42, 0x33, 0x71, 0x6f, 0x4f, 0x51, 0x3d, 0x3d, 0x0a,
			},
			want: &EchoToolsLobbySessionDataV1{
				SessionID: uuid.UUID{
					0x37, 0x43, 0x6b, 0x39, 0x4b, 0x65, 0x6e, 0x4c,
					0x74, 0x4c, 0x35, 0x58, 0x62, 0x71, 0x6c, 0x77,
				},
				TimeStepUsecs: 32000,
				EntrantCount:  0x4f5a4c4a31324e02,
				Entrants: []*EntrantData{
					{
						XPlatformId:      EvrId{0x4141414141414141, 0x4141414141414141},
						PlatformId:       0x4141414141414141,
						UniqueName:       []byte("0IVa7Y8CAAMAAAAAMAAAAAAAI0gAA"),
						DisplayName:      []byte("gAADMzMzMz"),
						SfwDisplayName:   []byte("MzMzMzM"),
						Censored:         0x414e,
						Owned:            true,
						Dirty:            true,
						CrossplayEnabled: true,
						Unused:           0x0,
						Ping:             0x0,
						GenIndex:         0x0a,
						TeamIndex:        0x0a,
						Json:             json.RawMessage([]byte("")),
					},
				},
			},
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			data, _ := WrapBytes(SymbolOf(tc.want), tc.data)

			messages, err := ParsePacket(data)
			if err != nil {
				t.Fatalf(err.Error())
			}

			if diff := cmp.Diff(tc.want, messages[0]); diff != "" {
				t.Errorf("unexpected LobbyFindSessionRequest (-want +got):\n%s", diff)
			}
		})
	}

}
