package evr

import (
	"encoding/json"
	"net"
	"testing"

	"github.com/gofrs/uuid/v5"
	"github.com/google/go-cmp/cmp"
)

func TestGameServerSessionParsers(t *testing.T) {
	testCases := []struct {
		name string
		data []byte
		want Message
	}{
		{
			name: "Game Server Registration",
			data: []byte{
				0x6e, 0xb6, 0xc0, 0xe4, 0xaa, 0xb1, 0xef, 0x11, 0xa3, 0xa0, 0x66, 0xd3, 0xff, 0x8a, 0x65, 0x3b,
				0x5b, 0x1f, 0xd2, 0xd4, 0xff, 0x3b, 0xe7, 0x94, 0xc0, 0xa8, 0x38, 0x01, 0x88, 0x1a, 0x00, 0x00,
				0x9e, 0x5b, 0x61, 0x5f, 0x99, 0x8a, 0xd3, 0x2f, 0x0d, 0x91, 0x77, 0x8f, 0xd7, 0x01, 0x2f, 0xc6,
				0x8d, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			},
			want: &EchoToolsGameServerRegistrationRequestV1{
				LoginSessionID: uuid.UUID{
					0xe4, 0xc0, 0xb6, 0x6e, 0xb1, 0xaa, 0x11, 0xef,
					0xa3, 0xa0, 0x66, 0xd3, 0xff, 0x8a, 0x65, 0x3b,
				},
				ServerID:      10729610607206735707,
				InternalIP:    net.IPv4(192, 168, 56, 1),
				Port:          6792,
				RegionHash:    Symbol(0x8a995f615b9e0000),
				VersionLock:   132732457728159699,
				TimeStepUsecs: 546162223,
			},
		},
		{
			name: "Game Server Session Status",
			data: []byte{
				0x4f, 0x57, 0x74, 0x44, 0x4e, 0x32, 0x56, 0x4c, 0x54, 0x47, 0x35, 0x71,
				0x54, 0x48, 0x51, 0x31, 0x57, 0x47, 0x4a, 0x78, 0x62, 0x48, 0x64, 0x57,
				0x51, 0x6d, 0x74, 0x7a, 0x61, 0x6d, 0x64, 0x42, 0x51, 0x55, 0x46, 0x42,
				0x51, 0x55, 0x46, 0x42, 0x51, 0x55, 0x46, 0x57, 0x51, 0x6c, 0x64, 0x77,
				0x53, 0x6e, 0x64, 0x46, 0x53, 0x6d, 0x52, 0x46, 0x51, 0x30, 0x39, 0x59,
				0x57, 0x44, 0x5a, 0x59, 0x4d, 0x45, 0x46, 0x6e, 0x62, 0x54, 0x49, 0x77,
				0x57, 0x56, 0x46, 0x42, 0x0a, 0x51, 0x55, 0x46, 0x42, 0x51, 0x55, 0x46,
				0x42, 0x51, 0x54, 0x68, 0x42, 0x51, 0x55, 0x46, 0x42, 0x51, 0x55, 0x46,
				0x42, 0x51, 0x55, 0x46, 0x42, 0x54, 0x55, 0x46, 0x42, 0x51, 0x55, 0x46,
				0x42, 0x51, 0x55, 0x46, 0x42, 0x51, 0x55, 0x4e, 0x44, 0x55, 0x48, 0x42,
				0x69, 0x62, 0x55, 0x52, 0x42, 0x5a, 0x30, 0x46, 0x42, 0x51, 0x55, 0x46,
				0x42, 0x51, 0x55, 0x46, 0x42, 0x51, 0x55, 0x46, 0x42, 0x51, 0x55, 0x45,
				0x4b, 0x0a,
			},

			want: &EchoToolsLobbyStatusV1{
				LobbySessionID: uuid.UUID{
					0xfb, 0xb9, 0x0c, 0x3a, 0xf0, 0x7f, 0x4d, 0xab, 0x93, 0x07, 0x2d, 0x7a, 0x69, 0xce, 0x40, 0xd8,
				},
				TimeStepUsecs: 4166,
				Slots: []*EntrantData{
					{
						XPlatformId:      EvrId{12, 4702111234474983745},
						PlatformId:       0x4141414141414141,
						UniqueName:       []byte("0IVa7Y8CAAMAAAAAMAAAAAAAI0gAA"),
						DisplayName:      []byte("gAADMzMzMz"),
						SfwDisplayName:   []byte("MzMzMzM"),
						Censored:         4166,
						Owned:            true,
						Dirty:            true,
						CrossplayEnabled: true,
						Unused:           0x0,
						Ping:             0x0,
						GenIndex:         0x0a,
						TeamIndex:        0x0a,
						Json:             json.RawMessage([]byte("")),
					},
				},
			},
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			data, _ := WrapBytes(SymbolOf(tc.want), tc.data)

			messages, err := ParsePacket(data)
			if err != nil {
				t.Fatalf(err.Error())
			}

			if diff := cmp.Diff(tc.want, messages[0]); diff != "" {
				t.Errorf("unexpected LobbyFindSessionRequest (-want +got):\n%s", diff)
			}
		})
	}

}
